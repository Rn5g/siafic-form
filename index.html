<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SIAFIC-PR | Formulário Oficial</title>
    <style>
        body { font-family: "Arial", sans-serif; background: #525659; display: flex; justify-content: center; padding: 10px; margin: 0; }
        .page { width: 210mm; min-height: 292mm; padding: 5mm 12mm; background: white; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .header-title { text-align: center; font-weight: bold; font-size: 11pt; text-decoration: underline; margin-bottom: 5px; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; margin-bottom: -1px; table-layout: fixed; }
        td { border: 1px solid black; padding: 2px 5px; font-size: 8.5pt; vertical-align: middle; }
        .section-gray { background-color: #f2f2f2; text-align: center; font-weight: bold; font-size: 8.5pt; height: 16px; }
        input[type="text"], input[type="email"], textarea { border: none; outline: none; width: 95%; font-family: inherit; font-size: 8.5pt; background: white; padding: 1px; }
        
        /* DESTAQUE DE CAMPOS OBRIGATÓRIOS */
        input:required, .req-blue { background-color: #eef6ff !important; }
        
        .check-box { width: 11px; height: 11px; border: 1px solid black; display: inline-block; margin: 0 2px; cursor: pointer; text-align: center; line-height: 10px; font-size: 8pt; font-weight: bold; vertical-align: middle; background: white; }
        #btn-print { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; background: #004a8d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        
        @media print { body { background: none; padding: 0; } #btn-print { display: none; } input, textarea { background: transparent !important; } .page { box-shadow: none; margin: 0; height: 100%; } .req-blue { background: transparent !important; } }
    </style>
</head>
<body>

<div class="page" id="form-content">
    <div class="header-title">FORMULÁRIO PARA INCLUSÃO E ALTERAÇÃO DE PERFIL DE USUÁRIO SISTEMA SIAFIC-PR</div>

    <table>
        <tr>
            <td width="15%">Finalidade:</td>
            <td class="req-blue">Cadastro (<span class="check-box fin-opt" onclick="ticarUnico(this)"></span>)</td>
            <td class="req-blue">Alteração (<span class="check-box fin-opt" onclick="ticarUnico(this)"></span>)</td>
            <td class="req-blue">Inativação (<span class="check-box fin-opt" onclick="ticarUnico(this)"></span>)</td>
        </tr>
    </table>

    <table><tr class="section-gray"><td>Dados do Usuário</td></tr></table>

    <table>
        <tr>
            <td colspan="2">Nome Completo: <input type="text" id="nome" required></td>
            <td width="30%">CPF: <input type="text" id="cpf" maxlength="14" required></td>
        </tr>
        <tr>
            <td colspan="2">E-mail Corporativo Pessoal: <input type="email" id="email" required></td>
            <td>Contador: Sim <span class="check-box" onclick="ticar(this)"></span> / Não <span class="check-box" onclick="ticar(this)"></span></td>
        </tr>
        <tr>
            <td width="30%">Telefone: <input type="text" id="tel" required></td>
            <td colspan="2">Número CRC: <input type="text" id="crc"></td>
        </tr>
        <tr>
            <td>Estagiário: Sim <span class="check-box" onclick="ticar(this)"></span> / Não <span class="check-box" onclick="ticar(this)"></span></td>
            <td>Terceiro: Sim <span class="check-box" onclick="ticar(this)"></span> / Não <span class="check-box" onclick="ticar(this)"></span></td>
            <td>Local de Lotação (sigla): <input type="text" id="lotacao" required></td>
        </tr>
    </table>

    <p style="font-size: 7.5pt; margin: 2px 0; font-weight: bold;">Marcar SIM nos Perfis aos quais o usuário poderá ter acesso e nos demais marcar NÃO.</p>

    <table>
        <tr class="section-gray"><td width="18%">OPÇÃO</td><td width="35%">PERFIL</td><td>PERMISSÕES DO PERFIL</td></tr>
        <script>
            const perfis = ["Consulta", "Cadastro Fornecedores¹", "Contratos¹", "Módulo Transferências", "NFS - Contabilidade", "NFS - Cotas Financeiras", "NFS - Elaboração Orçamentária Diretas", "NFS - Elaboração Orçamentária Indiretas", "NFS - Empenho²", "NFS - Financeiro²", "NFS - Liquidação²", "NFS - Solicitação Pagamento²", "NFS - Folha Pagamento", "Gerente OF", "Ordenador de Despesa", "Ordenador Financeiro"];
            perfis.forEach((n, i) => {
                let c3 = i === 0 ? `<td rowspan="16" style="font-size: 7pt; vertical-align: top; padding-top: 5px;">As permissões de cada perfil estão descritas no Anexo I - Lista de Perfis e Funcionalidades SIAFIC-PR, disponível em: https://siafic.fazenda.pr.gov.br/Pagina/cadastro.</td>` : "";
                document.write(`<tr><td style="text-align:center"><span class="check-box" onclick="ticar(this)"></span> SIM <span class="check-box" onclick="ticar(this)"></span> NÃO</td><td>${n}</td>${c3}</tr>`);
            });
        </script>
    </table>

    <table>
        <tr class="section-gray"><td>Código(s) da(s) Unidade(s) Gestora(s) a que o usuário terá acesso:</td></tr>
        <tr><td>Código UG de Lotação: <input type="text" id="ug_lot" required></td></tr>
        <tr><td>Códigos UG's de acesso: <input type="text" id="ug_acc" required></td></tr>
        <tr>
            <td><div style="font-size: 7.5pt; font-weight: bold;">Processos e atividades complementares:</div>
                <textarea rows="2" id="atividades" style="width:100%; border:none; resize:none; background:white;"></textarea></td>
        </tr>
    </table>

    <div style="margin-top: 15px; display: flex; justify-content: space-around; text-align: center; font-size: 8pt;">
        <div style="border-top: 1px solid black; width: 40%; padding-top: 3px;">Assinatura do Servidor</div>
        <div style="border-top: 1px solid black; width: 40%; padding-top: 3px;">Ordenador de Despesa</div>
    </div>
</div>

<button id="btn-print" onclick="validarEImprimir()">Gerar PDF Oficial</button>

<script>
    function ticar(el) { el.innerText = el.innerText.trim() === "X" ? "" : "X"; }

    function ticarUnico(el) {
        document.querySelectorAll('.fin-opt').forEach(box => box.innerText = "");
        el.innerText = "X";
    }

    // NOVA FUNÇÃO DE VALIDAÇÃO DE FINALIDADE
    function validarFinalidade() {
        return Array.from(document.querySelectorAll('.fin-opt'))
            .some(box => box.innerText.trim() === "X");
    }

    function validarEImprimir() {
        // 1. VALIDA FINALIDADE (USANDO A NOVA FUNÇÃO)
        if (!validarFinalidade()) {
            alert("Preencha o campo obrigatório: FINALIDADE (Cadastro, Alteração ou Inativação).");
            window.scrollTo(0,0);
            return;
        }

        // 2. VALIDA CAMPOS OBRIGATÓRIOS PADRÃO
        const obrigatorios = ['nome', 'cpf', 'email', 'tel', 'ug_lot', 'ug_acc'];
        if (obrigatorios.some(id => document.getElementById(id).value.trim() === "")) {
            alert("Preencha todos os campos obrigatórios destacados em azul.");
            return;
        }

        // 3. COLETAR DADOS E PERFIS
        let perfisSelecionados = [];
        document.querySelectorAll("tr").forEach(linha => {
            const celulas = linha.querySelectorAll("td");
            if (celulas.length >= 2) {
                const boxes = celulas[0].querySelectorAll(".check-box");
                if (boxes[0] && boxes[0].innerText.trim() === "X") {
                    perfisSelecionados.push(celulas[1].innerText);
                }
            }
        });

        const dados = {
            cpf: document.getElementById('cpf').value,
            nome: document.getElementById('nome').value,
            email: document.getElementById('email').value,
            tel: document.getElementById('tel').value,
            crc: document.getElementById('crc').value,
            ugs_combinadas: "Lotação: " + document.getElementById('ug_lot').value + " | Acesso: " + document.getElementById('ug_acc').value,
            perfis: perfisSelecionados.join(", "),
            atividades: document.getElementById('atividades').value
        };

        const scriptURL = 'https://script.google.com/macros/s/AKfycbw_3SV0lBdvhP1BCzGoheAjDyewa4f9yNiR94RjjaydRbgz2xf0M_TUaBe3V8YeQXBI/exec';

        fetch(scriptURL, {
            method: 'POST',
            body: JSON.stringify(dados)
        }).then(() => {
            window.print();
        }).catch(() => {
            window.print();
        });
    }
</script>
</body>
</html>
